# Echoes - The Quiet Frame

## Overview
Echoes is a cross-platform mobile application (iOS/Android) built with React Native and Expo. Its core purpose is to deliver personalized cosmic wisdom and awareness aligned with planetary rhythms. The app generates "echo cards" based on lunar phases, solar patterns, geomagnetic activity, global consciousness metrics, and cultural calendar systems. It provides location-aware, time-sensitive content without requiring user accounts or collecting personal data. The application's business vision is to offer contextual relevance derived from astronomical data, geographic location, timezone, and language preferences, fostering a unique approach to digital well-being and awareness.

## User Preferences
Preferred communication style: Simple, everyday language.

## System Architecture

### Mobile Application Framework
The application is built using **React Native with Expo SDK**, leveraging **Expo Router** for navigation and **TypeScript** for type safety. UI animations are handled with **React Native Reanimated** and **Gesture Handler**. The navigation is tab-based, featuring screens for Today, Field, Learn, Upcoming, and Settings.

### State Management
Global state is managed using **React Contexts**: `LocationContext` for handling user location, timezone, and language, and `ThemeContext` for dark/light theme management. Data is stored locally on the device, with no user accounts, ensuring a **local-first data storage** approach.

### Component Design
The app employs a modular component structure, including `EchoCard` for wisdom messages, `MoonPhase` for SVG-based lunar visualizations, `CalendarCarousel` for multi-calendar displays with tap-to-expand detail modals, and `MetricsGrid` for planetary data. Animations are optimized for 60fps using React Native Reanimated.

### Calendar Detail Modal
Tapping any calendar card on the Today tab opens a detail modal showing:
- Calendar name and current date
- Calendar type (Civil, Sacred, Lunisolar, Lunar)
- Significance - What this day means in that calendar system
- Energy - The spiritual/energetic quality of the day
- Phase - Current lunar or seasonal phase
- Element - For calendars that track elemental associations (e.g., Chinese)

### API Integration
Communication with The Quiet Frame (TQF) Planetary Awareness API is facilitated through a **backend proxy** for security and caching. A single primary endpoint (`/api/echoes/daily-bundle`) delivers most daily data. The app uses a **cache-first data fetching strategy** with `expires_at` timestamps from API responses and provides fallback mock data for offline scenarios. API requests include latitude, longitude, language code, and timezone for personalized content.

### Theme System
A **dual theme architecture** supports comprehensive dark and light modes, with dynamic detection of device preferences and manual override options.

### Content Generation
Echo cards are categorized into Lunar, Solar, Global Consciousness, Cultural Rhythms, and Ancestral Echo. The backend API assigns relevance scores based on astronomical conditions and user context. A daily fictional reflection prompt, "The Cookie," is generated by OpenAI's gpt-4o-mini for contemplative purposes, explicitly marked as fictional content.

### In-App Purchase & Subscription System
The app features a subscription-based monetization model ("Echoes Pro") integrated with Apple App Store and Google Play.

**Pricing:**
- Monthly: $7.99/month
- Yearly: $79.90/year (~2 months free)
- 3-day free trial (configured in store consoles)

**Architecture:**
- Client-side: `lib/iap/` contains products.ts, installId.ts, iap.ts, useEntitlement.ts
- Backend: `app/api/billing/` contains status, verify, and s2s notification endpoints
- Database: `entitlement_records` table tracks subscription status per device

**Required Secrets (Replit Secrets):**

Apple App Store Server API:
- `APPLE_IAP_PRIVATE_KEY` - PEM-encoded private key from App Store Connect > Keys > In-App Purchase
- `APPLE_IAP_KEY_ID` - Key ID from the same location
- `APPLE_IAP_ISSUER_ID` - Issuer ID from App Store Connect
- `APPLE_BUNDLE_ID` - App bundle ID (default: com.thequietframe.echoes)
- `APPLE_ENV` - 'sandbox' or 'production' (default: auto-detected from NODE_ENV)

Google Play Developer API:
- `GOOGLE_SERVICE_ACCOUNT_KEY` - Full JSON of service account credentials
- `GOOGLE_PACKAGE_NAME` - App package name (default: com.thequietframe.echoes)

**Key Files:**
- `lib/iap/appleVerify.ts` - Apple App Store Server API verification with JWT auth
- `lib/iap/googleVerify.ts` - Google Play Developer API verification with OAuth2
- `app/api/billing/verify+api.ts` - Unified verification endpoint
- `components/Paywall.tsx` - Subscription paywall UI

## External Dependencies

### Primary External Services
- **The Quiet Frame (TQF) Planetary Awareness API:** `https://source.thequietframe.com` provides planetary data, consciousness metrics, cultural calendar info, and AI-generated wisdom. Uses API key authentication (server-side).
- **Expo Platform Services:** Expo Go, Expo Location, Expo Localization, EAS for builds.
- **OpenAI (via Replit AI Integrations):** Used for generating "The Cookie" fictional content.

### Third-Party Libraries
- **UI & Animation:** `react-native-reanimated`, `react-native-gesture-handler`, `react-native-svg`, `@react-navigation`.
- **Utility Libraries:** `lucide-react-native`, `expo-haptics`, `react-native-safe-area-context`.
- **Development Tools:** TypeScript, Babel, Expo Metro bundler.
- **In-App Purchases:** `expo-iap`, `expo-secure-store`.
- **Internationalization:** `i18next`, `react-i18next` for multilingual support.

### Internationalization (i18n)
The app supports **6 languages**: English (en), Spanish (es), French (fr), Portuguese (pt), German (de), and Italian (it).

**Architecture:**
- `lib/i18n.ts` - i18n configuration with language detection and AsyncStorage persistence
- `lib/locales/*.json` - Translation files for each supported language

**Key Features:**
- Automatic device language detection via `expo-localization`
- Manual language override with persistence via AsyncStorage
- Language selector in Settings screen
- Fallback to English for unsupported languages

**Usage:**
```typescript
import { useTranslation } from 'react-i18next';
const { t } = useTranslation();
// Use: t('settings.title')
```

### Database & Backend
- **PostgreSQL with Drizzle ORM:** Used for persistent storage of cultural observances data (e.g., `cultural_observances` table). This includes pre-calculated moveable holidays for accurate global event tracking, sourced via the `date-holidays` library for country-specific holidays.
- **Neon serverless:** Hosts the PostgreSQL database.