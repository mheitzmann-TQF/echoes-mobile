We are implementing subscriptions with a 3-day free trial.

We will keep react-native-iap for purchase UX, BUT entitlement must be determined by our backend via receipt validation. The client must not treat local purchase presence as final truth.

Deliverables:
A) Client:
1) Add react-native-iap integration to perform purchase + restore.
2) After any purchase or restore, POST the purchase payload to backend endpoint:
   - POST /api/billing/verify
   Payload must include platform ("ios"|"android"), sku, and the store purchase token/receipt:
   - iOS: transactionReceipt (or signedTransaction/signedRenewal if available), plus transactionId if available
   - Android: purchaseToken, packageName, productId
   Include user identifier we already have (or device id if no auth).
3) Client receives response:
   { entitlement: "pro"|"free", expiresAt?: ISOString, source: "server" }
4) Gate premium features ONLY using server entitlement.
5) Keep "Restore Purchases" button that calls restore + then verify with backend.
6) Paywall UI must NOT promise a free trial unless HAS_TRIAL_OFFER is true.
7) Add clear logs prefixed [IAP] and [BILLING_VERIFY].

B) Backend:
Implement POST /api/billing/verify
- Validates receipt/token with Apple/Google (no mock validation).
- Returns entitlement pro/free + expiry.
- Persists latest entitlement state for the user.

Apple validation:
- Prefer App Store Server API / signed transactions if available.
- If using legacy verifyReceipt, support sandbox vs production endpoints.
- Handle status codes and environment switching safely.

Google validation:
- Use Google Play Developer API (service account).
- Verify purchaseToken for the subscription product.
- Return active/expired based on API response.

C) Server-to-server notifications (recommended next step, stub now):
- Add endpoints to receive Apple App Store Server Notifications v2 and Google RTDN.
- For now: stub routes + logging, and note config steps in comments.

Compatibility:
- Detect our Expo SDK + RN version and pin react-native-iap version accordingly.
- Ensure Android gradle/kotlin config is compatible.
- Confirm we are using dev client (not Expo Go).

Testing instructions:
- Provide exact steps for iOS sandbox tester purchase, cancellation, restore, and verifying server entitlement changes.